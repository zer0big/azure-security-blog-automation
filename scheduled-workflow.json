{
    "location": "koreacentral",
    "properties": {
        "definition": {
            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
            "contentVersion": "1.0.0.0",
            "parameters": {
                "$connections": {
                    "defaultValue": {},
                    "type": "Object"
                },
                "emailRecipient": {
                    "type": "String"
                },
                "rssFeedUrl": {
                    "type": "String"
                },
                "openAIKey": {
                    "type": "SecureString"
                }
            },
            "triggers": {
                "Daily_7AM_KST": {
                    "type": "Recurrence",
                    "recurrence": {
                        "frequency": "Day",
                        "interval": 1,
                        "schedule": {
                            "hours": ["7"]
                        },
                        "timeZone": "Korea Standard Time"
                    }
                }
            },
            "actions": {
                "Get_RSS_Feed": {
                    "inputs": {
                        "host": {
                            "connection": {
                                "name": "@parameters('$connections')['rss']['connectionId']"
                            }
                        },
                        "method": "get",
                        "path": "/ListFeedItems",
                        "queries": {
                            "feedUrl": "@parameters('rssFeedUrl')"
                        }
                    },
                    "runAfter": {},
                    "type": "ApiConnection"
                },
                "Filter_24h_Articles": {
                    "type": "Query",
                    "inputs": {
                        "from": "@body('Get_RSS_Feed')",
                        "where": "@greater(item()?['publishDate'], addDays(utcNow(), -1))"
                    },
                    "runAfter": {
                        "Get_RSS_Feed": ["Succeeded"]
                    }
                },
                "Get_Top_5_Articles": {
                    "type": "Compose",
                    "inputs": "@take(body('Get_RSS_Feed'), 5)",
                    "runAfter": {
                        "Get_RSS_Feed": ["Succeeded"]
                    }
                },
                "Initialize_Articles_Variable": {
                    "type": "InitializeVariable",
                    "inputs": {
                        "variables": [
                            {
                                "name": "articlesToProcess",
                                "type": "array",
                                "value": []
                            }
                        ]
                    },
                    "runAfter": {
                        "Filter_24h_Articles": ["Succeeded"],
                        "Get_Top_5_Articles": ["Succeeded"]
                    }
                },
                "Initialize_Notice_Variable": {
                    "type": "InitializeVariable",
                    "inputs": {
                        "variables": [
                            {
                                "name": "noticeMessage",
                                "type": "string",
                                "value": ""
                            }
                        ]
                    },
                    "runAfter": {
                        "Initialize_Articles_Variable": ["Succeeded"]
                    }
                },
                "Initialize_HTML_Content": {
                    "type": "InitializeVariable",
                    "inputs": {
                        "variables": [
                            {
                                "name": "htmlContent",
                                "type": "string",
                                "value": ""
                            }
                        ]
                    },
                    "runAfter": {
                        "Initialize_Notice_Variable": ["Succeeded"]
                    }
                },
                "Check_24h_Articles_Exist": {
                    "type": "If",
                    "expression": {
                        "and": [
                            {
                                "greater": [
                                    "@length(body('Filter_24h_Articles'))",
                                    0
                                ]
                            }
                        ]
                    },
                    "actions": {
                        "Set_Articles_24h": {
                            "type": "SetVariable",
                            "inputs": {
                                "name": "articlesToProcess",
                                "value": "@body('Filter_24h_Articles')"
                            },
                            "runAfter": {}
                        }
                    },
                    "else": {
                        "actions": {
                            "Set_Articles_Top5": {
                                "type": "SetVariable",
                                "inputs": {
                                    "name": "articlesToProcess",
                                    "value": "@outputs('Get_Top_5_Articles')"
                                },
                                "runAfter": {}
                            },
                            "Set_Notice_Message": {
                                "type": "SetVariable",
                                "inputs": {
                                    "name": "noticeMessage",
                                    "value": "<div style='background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;'><p style='margin: 0; color: #856404; font-weight: 600;'>âš ï¸ ìµœê·¼ 24ì‹œê°„ ë‚´ ê²Œì‹œëœ ê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p><p style='margin: 5px 0 0 0; color: #856404;'>ìµœê·¼ 5ê°œ ê²Œì‹œê¸€ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p></div>"
                                },
                                "runAfter": {
                                    "Set_Articles_Top5": ["Succeeded"]
                                }
                            }
                        }
                    },
                    "runAfter": {
                        "Initialize_HTML_Content": ["Succeeded"]
                    }
                },
                "For_each_RSS_Item": {
                    "type": "Foreach",
                    "foreach": "@variables('articlesToProcess')",
                    "actions": {
                        "Get_AI_Summary": {
                            "type": "Http",
                            "inputs": {
                                "method": "POST",
                                "uri": "https://aoai-knowledge-base-demo.cognitiveservices.azure.com/openai/deployments/gpt-4o/chat/completions?api-version=2024-08-01-preview",
                                "headers": {
                                    "Content-Type": "application/json",
                                    "api-key": "@{parameters('openAIKey')}"
                                },
                                "body": {
                                    "messages": [
                                        {
                                            "role": "system",
                                            "content": "ë‹¹ì‹ ì€ ë³´ì•ˆ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ë³´ì•ˆ ë¸”ë¡œê·¸ ê¸€ì„ ì •í™•í•˜ê²Œ 3ì¤„ë¡œ ìš”ì•½í•˜ì„¸ìš”.\n\në°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¥´ì„¸ìš”:\n1. [ì²« ë²ˆì§¸ í•µì‹¬ ë‚´ìš©]<br>\n2. [ë‘ ë²ˆì§¸ í•µì‹¬ ë‚´ìš©]<br>\n3. [ì„¸ ë²ˆì§¸ í•µì‹¬ ë‚´ìš©]\n\nê° ì¤„ì€ ë¸”ë¡œê·¸ ê¸€ì˜ êµ¬ì²´ì ì¸ í•µì‹¬ ë‚´ìš©ì„ ë‹´ì•„ì•¼ í•˜ë©°, ë°˜ë“œì‹œ í•œê¸€ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. ì¼ë°˜ì ì¸ ì„¤ëª…ì´ ì•„ë‹Œ í•´ë‹¹ ê¸€ì˜ ê³ ìœ í•œ ë‚´ìš©ì„ ìš”ì•½í•˜ì„¸ìš”."
                                        },
                                        {
                                            "role": "user",
                                            "content": "ì œëª©: @{items('For_each_RSS_Item')?['title']}\n\në‚´ìš©: @{items('For_each_RSS_Item')?['summary']}\n\nìœ„ ë¸”ë¡œê·¸ ê¸€ì„ ì •í™•íˆ 3ì¤„ë¡œ ìš”ì•½í•˜ì„¸ìš”. ë°˜ë“œì‹œ ë²ˆí˜¸ë¥¼ ë¶™ì´ê³  ê° ì¤„ ëì— <br> íƒœê·¸ë¥¼ ë„£ìœ¼ì„¸ìš”."
                                        }
                                    ],
                                    "temperature": 0.3,
                                    "max_tokens": 300
                                }
                            },
                            "runAfter": {}
                        },
                        "Append_Article_HTML": {
                            "type": "AppendToStringVariable",
                            "inputs": {
                                "name": "htmlContent",
                                "value": "<div class='article-card'>\n  <h2 class='article-title'><a href='@{items('For_each_RSS_Item')?['primaryLink']}' target='_blank'>@{items('For_each_RSS_Item')?['title']}</a></h2>\n  <div class='article-meta'>\n    <span class='date'>ğŸ“… @{formatDateTime(items('For_each_RSS_Item')?['publishDate'], 'yyyyë…„ MMì›” ddì¼ HH:mm')}</span>\n  </div>\n  <div class='ai-summary'>\n    <strong>ğŸ¤– AI ìš”ì•½:</strong><br>\n    @{body('Get_AI_Summary')?['choices']?[0]?['message']?['content']}\n  </div>\n  <a href='@{items('For_each_RSS_Item')?['primaryLink']}' class='read-more' target='_blank'>ìì„¸íˆ ë³´ê¸° â†’</a>\n</div>\n"
                            },
                            "runAfter": {
                                "Get_AI_Summary": ["Succeeded"]
                            }
                        }
                    },
                    "runAfter": {
                        "Check_24h_Articles_Exist": ["Succeeded"]
                    }
                },
                "Compose_Final_Email_HTML": {
                    "type": "Compose",
                    "inputs": "<!DOCTYPE html>\n<html lang='ko'>\n<head>\n  <meta charset='UTF-8'>\n  <meta name='viewport' content='width=device-width, initial-scale=1.0'>\n  <style>\n    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background-color: #f5f5f5; margin: 0; padding: 0; }\n    .container { max-width: 800px; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }\n    .header { background: #fff; color: #0078d4; padding: 30px; text-align: center; border-bottom: 3px solid #0078d4; }\n    .header h1 { margin: 0; font-size: 28px; font-weight: 600; color: #0078d4; }\n    .header p { margin: 5px 0 0 0; color: #555; }\n    .summary-bar { background: #f3f2f1; padding: 20px; border-left: 4px solid #0078d4; margin: 0; }\n    .summary-bar p { margin: 5px 0; font-size: 14px; }\n    .summary-bar strong { color: #0078d4; }\n    .content { padding: 20px; }\n    .article-card { background: #fafafa; border-left: 4px solid #0078d4; padding: 20px; margin-bottom: 20px; border-radius: 4px; transition: all 0.3s ease; }\n    .article-card:hover { background: #f0f0f0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }\n    .article-title { margin: 0 0 10px 0; font-size: 20px; }\n    .article-title a { color: #0078d4; text-decoration: none; }\n    .article-title a:hover { text-decoration: underline; }\n    .article-meta { margin-bottom: 10px; font-size: 13px; color: #666; }\n    .date { background: #e8e8e8; padding: 4px 10px; border-radius: 12px; }\n    .ai-summary { margin: 15px 0; padding: 15px; background: #e6f4ff; border-left: 3px solid #0078d4; color: #333; line-height: 1.6; border-radius: 4px; }\n    .ai-summary strong { color: #0078d4; }\n    .read-more { display: inline-block; background: #222; color: #fff; padding: 10px 20px; border-radius: 4px; text-decoration: none; font-size: 14px; font-weight: 600; margin-top: 10px; transition: all 0.3s; }\n    .read-more:hover { background: #000; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }\n    .footer { background: #f3f2f1; padding: 15px; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #ddd; }\n  </style>\n</head>\n<body>\n  <div class='container'>\n    <div class='header'>\n      <h1>ğŸ“° Microsoft Security Blog</h1>\n      <p>ìµœì‹  ë³´ì•ˆ ë¸”ë¡œê·¸ ê²Œì‹œê¸€</p>\n    </div>\n    <div class='summary-bar'>\n      <p>ğŸ• <strong>ì—…ë°ì´íŠ¸:</strong> @{formatDateTime(utcNow(), 'yyyyë…„ MMì›” ddì¼ HH:mm')} (KST)</p>\n      <p>ğŸ“Š <strong>ì´ ê²Œì‹œê¸€:</strong> @{length(variables('articlesToProcess'))}ê°œ</p>\n    </div>\n    <div class='content'>\n      @{variables('noticeMessage')}\n      @{variables('htmlContent')}\n    </div>\n    <div class='footer'>\n      <p>ì´ ë©”ì¼ì€ Azure Logic Appsë¥¼ í†µí•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>\n      <p>Microsoft Security Blog RSS Feed | ë§¤ì¼ ì˜¤ì „ 7ì‹œ ë°œì†¡</p>\n    </div>\n  </div>\n</body>\n</html>",
                    "runAfter": {
                        "For_each_RSS_Item": ["Succeeded"]
                    }
                },
                "Send_RSS_Email": {
                    "inputs": {
                        "body": {
                            "Subject": "ğŸ“° Microsoft Security Blog - @{formatDateTime(utcNow(), 'yyyyë…„ MMì›” ddì¼')} ìµœì‹  ê²Œì‹œê¸€",
                            "To": "@parameters('emailRecipient')",
                            "Body": "@{outputs('Compose_Final_Email_HTML')}",
                            "Importance": "High"
                        },
                        "host": {
                            "connection": {
                                "name": "@parameters('$connections')['office365']['connectionId']"
                            }
                        },
                        "path": "/v2/Mail",
                        "method": "post"
                    },
                    "runAfter": {
                        "Compose_Final_Email_HTML": ["Succeeded"]
                    },
                    "type": "ApiConnection"
                }
            },
            "outputs": {}
        },
        "parameters": {
            "$connections": {
                "value": {
                    "office365": {
                        "connectionId": "/subscriptions/3864b016-4594-40ad-a96b-4a08ac96b537/resourceGroups/rg-security-blog-automation-dev/providers/Microsoft.Web/connections/office365-dev-security-blog-automation",
                        "connectionName": "office365",
                        "id": "/subscriptions/3864b016-4594-40ad-a96b-4a08ac96b537/providers/Microsoft.Web/locations/koreacentral/managedApis/office365"
                    },
                    "rss": {
                        "connectionId": "/subscriptions/3864b016-4594-40ad-a96b-4a08ac96b537/resourceGroups/rg-security-blog-automation-dev/providers/Microsoft.Web/connections/rss-dev-security-blog-automation",
                        "connectionName": "rss",
                        "id": "/subscriptions/3864b016-4594-40ad-a96b-4a08ac96b537/providers/Microsoft.Web/locations/koreacentral/managedApis/rss"
                    }
                }
            },
            "emailRecipient": {
                "value": "azure-mvp@zerobig.kr"
            },
            "rssFeedUrl": {
                "value": "https://www.microsoft.com/en-us/security/blog/feed/"
            },
            "openAIKey": {
                "value": "YOUR_AZURE_OPENAI_API_KEY_HERE"
            }
        }
    }
}
