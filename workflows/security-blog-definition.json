{
    "$schema":  "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion":  "1.0.0.0",
    "parameters":  {

                        "$connections":  {
                                              "defaultValue":  {

                                                               },
                                              "type":  "Object"
                                          },
                        "emailRecipient":  {
                                                "type":  "String",
                                                "metadata":  {
                                                                 "description":  "이메일 수신자 주소"
                                                             }
                                            },
                        "rssFeedUrl":  {
                                           "type":  "String",
                                           "defaultValue":  "https://www.microsoft.com/en-us/security/blog/feed/",
                                           "metadata":  {
                                                            "description":  "RSS 피드 URL"
                                                        }
                                       }
                    },
    "triggers":  {
                     "Recurrence":  {
                                        "recurrence":  {
                                                           "frequency":  "Day",
                                                           "interval":  1,
                                                           "schedule":  {
                                                                            "hours":  [
                                                                                          "9"
                                                                                      ],
                                                                            "minutes":  [
                                                                                            0
                                                                                        ]
                                                                        },
                                                           "timeZone":  "Korea Standard Time"
                                                       },
                                        "type":  "Recurrence"
                                    }
                 },
    "actions":  {
                    "Validate_RSS_Feed_URL":  {
                                                   "actions":  {
                                                                   "List_RSS":  {
                                                                                   "inputs":  {
                                                                                                  "host":  {
                                                                                                               "connection":  {
                                                                                                                                  "referenceName":  "rss"
                                                                                                                              }
                                                                                                           },
                                                                                                  "path":  "/ListFeedItems",
                                                                                                  "queries":  {
                                                                                                                  "feedUrl":  "@parameters(\u0027rssFeedUrl\u0027)"
                                                                                                              },
                                                                                                  "method":  "get"
                                                                                              },
                                                                                   "runAfter":  {

                                                                                                },
                                                                                   "type":  "ApiConnection"
                                                                               },
                                                                   "Send_Test_Email":  {
                                                                                          "inputs":  {
                                                                                                         "body":  {
                                                                                                                      "Subject":  "✅ Logic App 테스트 - @{utcNow()}",
                                                                                                                      "To":  "@parameters(\u0027emailRecipient\u0027)",
                                                                                                                      "Body":  "<h2>Logic App 동작 확인 테스트</h2><p><strong>이메일 발송 성공!</strong></p><p>수신자: @{parameters(\u0027emailRecipient\u0027)}</p><p>시간: @{utcNow()}</p><hr/><p>RSS 피드 조회 완료. 이 이메일이 도착했다면 전체 시스템이 정상 작동 중입니다.</p>",
                                                                                                                      "Importance":  "High"
                                                                                                                  },
                                                                                                         "host":  {
                                                                                                                      "connection":  {
                                                                                                                                         "referenceName":  "office365"
                                                                                                                                     }
                                                                                                                  },
                                                                                                         "path":  "/v2/Mail",
                                                                                                         "method":  "post"
                                                                                                     },
                                                                                          "runAfter":  {
                                                                                                           "List_RSS":  [
                                                                                                                            "Succeeded"
                                                                                                                        ]
                                                                                                       },
                                                                                          "type":  "ApiConnection"
                                                                                      },
                                                                   "Send_RSS_Error_Email":  {
                                                                                                "inputs":  {
                                                                                                               "body":  {
                                                                                                                            "Subject":  "❌ Logic App 오류 - RSS 조회 실패 - @{utcNow()}",
                                                                                                                            "To":  "@parameters(\u0027emailRecipient\u0027)",
                                                                                                                            "Body":  "<h2>RSS 조회 실패</h2><p>rssFeedUrl: @{parameters(\u0027rssFeedUrl\u0027)}</p><p>실행 ID: @{workflow().run.name}</p><p>상태: @{actions(\u0027List_RSS\u0027).status}</p><pre>@{string(actions(\u0027List_RSS\u0027))}</pre>",
                                                                                                                            "Importance":  "High"
                                                                                                                        },
                                                                                                               "host":  {
                                                                                                                            "connection":  {
                                                                                                                                               "referenceName":  "office365"
                                                                                                                                           }
                                                                                                                        },
                                                                                                               "path":  "/v2/Mail",
                                                                                                               "method":  "post"
                                                                                                           },
                                                                                                "runAfter":  {
                                                                                                                 "List_RSS":  [
                                                                                                                                  "Failed",
                                                                                                                                  "TimedOut"
                                                                                                                              ]
                                                                                                             },
                                                                                                "type":  "ApiConnection"
                                                                                            },
                                                                   "Terminate_On_RSS_Error":  {
                                                                                                   "inputs":  {
                                                                                                                  "runStatus":  "Failed",
                                                                                                                  "runError":  {
                                                                                                                                   "code":  "RssFeedFetchFailed",
                                                                                                                                   "message":  "Failed to fetch RSS feed items"
                                                                                                                               }
                                                                                                              },
                                                                                                   "runAfter":  {
                                                                                                                    "Send_RSS_Error_Email":  [
                                                                                                                                                "Succeeded",
                                                                                                                                                "Failed"
                                                                                                                                            ]
                                                                                                                },
                                                                                                   "type":  "Terminate"
                                                                                               }
                                                               },
                                                   "else":  {
                                                                "actions":  {
                                                                                "Send_Invalid_RSS_Email":  {
                                                                                                                "inputs":  {
                                                                                                                               "body":  {
                                                                                                                                            "Subject":  "❌ Logic App 오류 - RSS URL 유효성 실패 - @{utcNow()}",
                                                                                                                                            "To":  "@parameters(\u0027emailRecipient\u0027)",
                                                                                                                                            "Body":  "<h2>RSS URL 유효성 검사 실패</h2><p>rssFeedUrl 값이 비어있거나 https://로 시작하지 않습니다.</p><p>rssFeedUrl: @{parameters(\u0027rssFeedUrl\u0027)}</p><p>실행 ID: @{workflow().run.name}</p>",
                                                                                                                                            "Importance":  "High"
                                                                                                                                        },
                                                                                                                               "host":  {
                                                                                                                                            "connection":  {
                                                                                                                                                               "referenceName":  "office365"
                                                                                                                                                           }
                                                                                                                                        },
                                                                                                                               "path":  "/v2/Mail",
                                                                                                                               "method":  "post"
                                                                                                                           },
                                                                                                                "runAfter":  {

                                                                                                                             },
                                                                                                                "type":  "ApiConnection"
                                                                                                            },
                                                                                "Terminate_On_Invalid_RSS":  {
                                                                                                                   "inputs":  {
                                                                                                                                  "runStatus":  "Failed",
                                                                                                                                  "runError":  {
                                                                                                                                                   "code":  "InvalidRssFeedUrl",
                                                                                                                                                   "message":  "rssFeedUrl is empty or not https"
                                                                                                                                               }
                                                                                                                              },
                                                                                                                   "runAfter":  {
                                                                                                                                    "Send_Invalid_RSS_Email":  [
                                                                                                                                                                 "Succeeded",
                                                                                                                                                                 "Failed"
                                                                                                                                                             ]
                                                                                                                                },
                                                                                                                   "type":  "Terminate"
                                                                                                               }
                                                                            }
                                                            },
                                                   "expression":  {
                                                                      "and":  [
                                                                                  {
                                                                                      "not":  [
                                                                                                  {
                                                                                                      "empty":  [
                                                                                                                   "@parameters(\u0027rssFeedUrl\u0027)"
                                                                                                               ]
                                                                                                  }
                                                                                              ]
                                                                                  },
                                                                                  {
                                                                                      "startsWith":  [
                                                                                                        "@parameters(\u0027rssFeedUrl\u0027)",
                                                                                                        "https://"
                                                                                                    ]
                                                                                  }
                                                                              ]
                                                                  },
                                                   "runAfter":  {

                                                                },
                                                   "type":  "If"
                                               }
                },
    "outputs":  {

                }
}
