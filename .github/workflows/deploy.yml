name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP_PREFIX: rg-security-blog-automation

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      functions: ${{ steps.filter.outputs.functions }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Path filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            functions:
              - 'functions/**'

  validate:
    name: Validate Bicep Template
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep template
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          az deployment group validate \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --template-file infra/bicep/main.bicep \
            --parameters @infra/bicep/parameters.${ENV}.json \
            --verbose

  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      logic-app-name: ${{ steps.deploy.outputs.logicAppName }}
      logic-app-id: ${{ steps.deploy.outputs.logicAppId }}
      function-app-name: ${{ steps.deploy.outputs.functionAppName }}
      function-app-url: ${{ steps.deploy.outputs.functionAppUrl }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep template
        id: deploy
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          
          # Resource Group 議댁옱 ?щ? ?뺤씤 諛??앹꽦
          if ! az group exists --name ${RESOURCE_GROUP_PREFIX}-${ENV}; then
            echo "Creating resource group ${RESOURCE_GROUP_PREFIX}-${ENV}..."
            az group create \
              --name ${RESOURCE_GROUP_PREFIX}-${ENV} \
              --location koreacentral \
              --tags Environment=${ENV} Project=security-blog-automation ManagedBy=GitHubActions
          fi
          
          # Bicep 諛고룷
          DEPLOYMENT_OUTPUT=$(az deployment group create \
            --name main \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --template-file infra/bicep/main.bicep \
            --parameters @infra/bicep/parameters.${ENV}.json \
            --parameters emailRecipient=${{ secrets.EMAIL_RECIPIENT }} \
            --parameters openAiEndpoint=${{ secrets.OPENAI_ENDPOINT }} \
            --parameters openAiDeploymentName=${{ secrets.OPENAI_DEPLOYMENT_NAME }} \
            --output json)
          
          # Outputs 異붿텧
          LOGIC_APP_NAME=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.logicAppName.value')
          LOGIC_APP_ID=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.logicAppId.value')
          FUNCTION_APP_NAME=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.functionAppName.value')
          FUNCTION_APP_URL=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.functionAppUrl.value')
          
          echo "logicAppName=$LOGIC_APP_NAME" >> $GITHUB_OUTPUT
          echo "logicAppId=$LOGIC_APP_ID" >> $GITHUB_OUTPUT
          echo "functionAppName=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "functionAppUrl=$FUNCTION_APP_URL" >> $GITHUB_OUTPUT
          
          echo "??Infrastructure deployed successfully"
          echo "Logic App: $LOGIC_APP_NAME"

  deploy-functions:
    name: Deploy Azure Functions
    needs: [deploy-infrastructure, detect-changes]
    if: ${{ github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.functions == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build & publish Functions
        run: |
          dotnet publish functions/ProcessedPostsApi.csproj -c Release -o functions/publish

      - name: Zip package
        run: |
          cd functions/publish
          zip -r ../functionapp.zip .

      - name: Zip Deploy
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          FUNCTION_APP_NAME="${{ needs.deploy-infrastructure.outputs.function-app-name }}"

          echo "Deploying Functions to: ${FUNCTION_APP_NAME} (rg: ${RESOURCE_GROUP_PREFIX}-${ENV})"

          az functionapp deployment source config-zip \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name ${FUNCTION_APP_NAME} \
            --src functions/functionapp.zip

  deploy-workflow:
    name: Deploy Logic App Workflow
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Checkout workflows
        uses: actions/checkout@v4
        
      - name: Update Logic App workflow
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          LOGIC_APP_NAME="${{ needs.deploy-infrastructure.outputs.logic-app-name }}"
          FUNCTIONS_APP_URL="${{ needs.deploy-infrastructure.outputs.function-app-url }}"
          FUNCTION_APP_NAME="${{ needs.deploy-infrastructure.outputs.function-app-name }}"

          # CI/개발 환경에서 과도하게 오래 걸리는 것을 방지
          if [ "$ENV" = "dev" ]; then
            RSS_ITEM_LIMIT=2
          else
            RSS_ITEM_LIMIT=10
          fi
          
          echo "Updating workflow for Logic App: $LOGIC_APP_NAME"
          
          # Get connection IDs
          RSS_CONN_ID=$(az deployment group show \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name main \
            --query "properties.outputs.rssConnectionId.value" -o tsv)
          
          OFFICE365_CONN_ID=$(az deployment group show \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name main \
            --query "properties.outputs.office365ConnectionId.value" -o tsv)

          # Get Function host key (x-functions-key)
          KEYS_JSON=$(az functionapp keys list \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name "$FUNCTION_APP_NAME" \
            --output json)

          FUNCTION_KEY=$(echo "$KEYS_JSON" | jq -r '.functionKeys.default // .functionKeys["default"] // (.functionKeys | to_entries[0].value) // empty')
          if [ -z "$FUNCTION_KEY" ] || [ "$FUNCTION_KEY" = "null" ]; then
            echo "Failed to retrieve Function host key for app: $FUNCTION_APP_NAME"
            echo "$KEYS_JSON"
            exit 1
          fi

          # Workflow payload 생성 (jq로 안전하게 구성)
          jq -n \
            --slurpfile def workflows/security-blog-definition.json \
            --arg openAiEndpoint "${{ secrets.OPENAI_ENDPOINT }}" \
            --arg openAiDeploymentName "${{ secrets.OPENAI_DEPLOYMENT_NAME }}" \
            --arg emailRecipient "${{ secrets.EMAIL_RECIPIENT }}" \
            --arg rssFeedUrl "https://www.microsoft.com/en-us/security/blog/feed/" \
            --argjson rssItemLimit "$RSS_ITEM_LIMIT" \
            --arg functionsAppUrl "$FUNCTIONS_APP_URL" \
            --arg functionKey "$FUNCTION_KEY" \
            --arg rssConnId "$RSS_CONN_ID" \
            --arg office365ConnId "$OFFICE365_CONN_ID" \
            '{
              location: "koreacentral",
              properties: {
                definition: $def[0],
                parameters: {
                  "$connections": {
                    value: {
                      rss: {
                        connectionId: $rssConnId,
                        connectionName: "rss",
                        id: "/subscriptions/\(env.AZURE_SUBSCRIPTION_ID)/providers/Microsoft.Web/locations/koreacentral/managedApis/rss"
                      },
                      office365: {
                        connectionId: $office365ConnId,
                        connectionName: "office365",
                        id: "/subscriptions/\(env.AZURE_SUBSCRIPTION_ID)/providers/Microsoft.Web/locations/koreacentral/managedApis/office365"
                      }
                    }
                  },
                  openAiEndpoint: { value: $openAiEndpoint },
                  openAiDeploymentName: { value: $openAiDeploymentName },
                  emailRecipient: { value: $emailRecipient },
                  rssFeedUrl: { value: $rssFeedUrl },
                  rssItemLimit: { value: $rssItemLimit },
                  functionsAppUrl: { value: $functionsAppUrl },
                  functionKey: { value: $functionKey }
                }
              }
            }' > workflow-payload.json

          # REST API로 업데이트
          LOGIC_APP_ID=$(az logic workflow show \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name $LOGIC_APP_NAME \
            --query id -o tsv)

          az rest \
            --method PUT \
            --uri "${LOGIC_APP_ID}?api-version=2019-05-01" \
            --headers "Content-Type=application/json" \
            --body @workflow-payload.json
          
          echo " Workflow deployed successfully"

  configure-managed-identity:
    name: Configure Managed Identity
    needs: [deploy-infrastructure, deploy-workflow]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Assign OpenAI role to Logic App
        run: |
          set -u
          set -o pipefail
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          LOGIC_APP_NAME="${{ needs.deploy-infrastructure.outputs.logic-app-name }}"
          FUNCTION_APP_NAME="${{ needs.deploy-infrastructure.outputs.function-app-name }}"

          # Resolve the Azure OpenAI resource scope for RBAC.
          # Prefer the actually deployed Function App AOAI_ENDPOINT (best source of truth), then fall back to secrets.
          FUNC_AOAI_ENDPOINT=$(az functionapp config appsettings list \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name $FUNCTION_APP_NAME \
            --query "[?name=='AOAI_ENDPOINT'].value | [0]" -o tsv 2>/dev/null || true)

          OPENAI_ENDPOINT="${FUNC_AOAI_ENDPOINT:-${{ secrets.OPENAI_ENDPOINT }}}"
          AOAI_HOST=$(echo "$OPENAI_ENDPOINT" | sed -E 's#^https?://([^/]+)/?.*$#\1#')
          AOAI_NAME=$(echo "$AOAI_HOST" | cut -d'.' -f1)

          OPENAI_SCOPE=$(az resource list \
            --resource-type "Microsoft.CognitiveServices/accounts" \
            --name "$AOAI_NAME" \
            --query "[0].id" -o tsv 2>/dev/null || true)

          if [ -z "$OPENAI_SCOPE" ]; then
            OPENAI_SCOPE="${{ secrets.OPENAI_RESOURCE_ID }}"
          fi

          if [ -z "$OPENAI_SCOPE" ]; then
            echo "❌ Failed to resolve Azure OpenAI resource id for RBAC scope."
            echo "- Checked Function App setting AOAI_ENDPOINT: '${FUNC_AOAI_ENDPOINT:-<empty>}'"
            echo "- Checked secrets.OPENAI_ENDPOINT and secrets.OPENAI_RESOURCE_ID"
            exit 1
          fi

          echo "Using OpenAI RBAC scope: $OPENAI_SCOPE"
          
          # Logic App Managed Identity Principal ID 異붿텧
          PRINCIPAL_ID=$(az logic workflow show \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name $LOGIC_APP_NAME \
            --query identity.principalId -o tsv)
          
          echo "Logic App Principal ID: $PRINCIPAL_ID"
          
          # Azure OpenAI 由ъ냼?ㅼ뿉 ??븷 ?좊떦
          EXISTS=$(az role assignment list \
            --assignee $PRINCIPAL_ID \
            --scope $OPENAI_SCOPE \
            --role "Cognitive Services OpenAI User" \
            --query "length(@)" -o tsv 2>/dev/null || echo "")

          if [ -n "$EXISTS" ] && [ "$EXISTS" != "0" ]; then
            echo "Role assignment already exists for Logic App."
          else
            if az role assignment create \
              --assignee-object-id $PRINCIPAL_ID \
              --assignee-principal-type ServicePrincipal \
              --role "Cognitive Services OpenAI User" \
              --scope $OPENAI_SCOPE; then
              echo "Role assignment created for Logic App."
            else
              echo "⚠️ Failed to create role assignment for Logic App (likely missing Microsoft.Authorization/roleAssignments/write)."
              echo "   If integration test fails with PermissionDenied, grant the GitHub OIDC principal 'Owner' or 'User Access Administrator' on the OpenAI scope (or broader)."
            fi
          fi

          # Function App Managed Identity에도 동일 역할 할당 (Functions에서 AOAI 호출)
          FUNC_PRINCIPAL_ID=$(az functionapp identity show \
            --resource-group ${RESOURCE_GROUP_PREFIX}-${ENV} \
            --name $FUNCTION_APP_NAME \
            --query principalId -o tsv)

          echo "Function App Principal ID: $FUNC_PRINCIPAL_ID"

          EXISTS=$(az role assignment list \
            --assignee $FUNC_PRINCIPAL_ID \
            --scope $OPENAI_SCOPE \
            --role "Cognitive Services OpenAI User" \
            --query "length(@)" -o tsv 2>/dev/null || echo "")

          if [ -n "$EXISTS" ] && [ "$EXISTS" != "0" ]; then
            echo "Role assignment already exists for Function App."
          else
            if az role assignment create \
              --assignee-object-id $FUNC_PRINCIPAL_ID \
              --assignee-principal-type ServicePrincipal \
              --role "Cognitive Services OpenAI User" \
              --scope $OPENAI_SCOPE; then
              echo "Role assignment created for Function App."
            else
              echo "⚠️ Failed to create role assignment for Function App (likely missing Microsoft.Authorization/roleAssignments/write)."
              echo "   If integration test fails with PermissionDenied, grant the GitHub OIDC principal 'Owner' or 'User Access Administrator' on the OpenAI scope (or broader)."
            fi
          fi
          
          echo "??Managed Identity configured successfully"

  integration-test:
    name: Run Integration Test
    needs: [deploy-infrastructure, configure-managed-identity]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure Logic Apps extension
        run: az extension add --name logic

      - name: Trigger Logic App manually
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          LOGIC_APP_NAME="${{ needs.deploy-infrastructure.outputs.logic-app-name }}"
          TRIGGER_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # 트리거 전 "가장 최근 run"을 저장해두고, 트리거 후 새로 생성된 run을 찾아서 그 run만 추적
          PRE_RUN_ID=$(az rest --method GET \
            --uri "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_PREFIX}-${ENV}/providers/Microsoft.Logic/workflows/$LOGIC_APP_NAME/runs?api-version=2016-06-01&\$top=1" \
            --query "value[0].name" -o tsv 2>/dev/null || true)
          echo "Pre-run id: ${PRE_RUN_ID:-<none>}"
          
          echo "Triggering Logic App: $LOGIC_APP_NAME"
          # 수동 트리거 실행 (az rest 사용)
          az rest --method POST \
            --uri "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_PREFIX}-${ENV}/providers/Microsoft.Logic/workflows/$LOGIC_APP_NAME/triggers/Recurrence/run?api-version=2016-06-01"

          echo "🔎 Finding newly created run id..."
          RUN_ID=""
          for i in $(seq 1 24); do
            RUN_ID=$(az rest --method GET \
              --uri "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_PREFIX}-${ENV}/providers/Microsoft.Logic/workflows/$LOGIC_APP_NAME/runs?api-version=2016-06-01&\$top=5" \
              -o json | jq -r --arg pre "$PRE_RUN_ID" '.value | map(select(.name != $pre)) | .[0].name // empty')

            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              echo "Run id: $RUN_ID"
              break
            fi

            echo "[$i/24] waiting for run creation..."
            sleep 5
          done

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "❌ Failed to discover new run id"
            exit 1
          fi

          echo "⏳ Waiting for workflow to complete (up to 10 minutes)..."

          for i in $(seq 1 60); do
            RUN_STATUS=$(az rest --method GET \
              --uri "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_PREFIX}-${ENV}/providers/Microsoft.Logic/workflows/$LOGIC_APP_NAME/runs/$RUN_ID?api-version=2016-06-01" \
              --query "properties.status" -o tsv)

            echo "[$i/60] Run Status: $RUN_STATUS (runId: $RUN_ID, triggered at: $TRIGGER_TIME)"

            if [ "$RUN_STATUS" = "Succeeded" ]; then
              echo "✅ Integration test passed"
              exit 0
            fi

            if [ "$RUN_STATUS" = "Failed" ] || [ "$RUN_STATUS" = "Cancelled" ] || [ "$RUN_STATUS" = "TimedOut" ]; then
              echo "❌ Integration test failed"
              # 실패 시 액션 요약을 추가로 출력
              az rest --method GET \
                --uri "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_PREFIX}-${ENV}/providers/Microsoft.Logic/workflows/$LOGIC_APP_NAME/runs/$RUN_ID/actions?api-version=2016-06-01" \
                -o json | jq -r '.value[] | "- \(.name): \(.properties.status)"' || true
              exit 1
            fi

            sleep 10
          done

          echo "⏰ Integration test timed out (still not Succeeded)"
          # 타임아웃 시 액션 요약 출력
          az rest --method GET \
            --uri "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_PREFIX}-${ENV}/providers/Microsoft.Logic/workflows/$LOGIC_APP_NAME/runs/$RUN_ID/actions?api-version=2016-06-01" \
            -o json | jq -r '.value[] | "- \(.name): \(.properties.status)"' || true
          exit 1

  notify:
    name: Send Deployment Notification
    needs: integration-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send success notification
        if: needs.integration-test.result == 'success'
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "??Deployment to $ENV environment completed successfully"
          
      - name: Send failure notification
        if: needs.integration-test.result == 'failure'
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "??Deployment to $ENV environment failed"
          exit 1

