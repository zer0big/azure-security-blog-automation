# 아키텍처 문서

## 시스템 개요

**Azure Security Blog Automation** 시스템은 Microsoft 보안 및 Azure 클라우드 블로그 게시글을 자동으로 수집하고 요약하여 이메일로 배포하는 서버리스 이벤트 기반 솔루션입니다. 

### 듀얼 워크플로우 아키텍처

시스템은 **2개의 독립적인 Logic App (Standard) 워크플로우**로 구성되어 있습니다:

1. **Security Workflow** - 5개 보안 피드 (07:00, 15:00, 22:00 KST)
2. **Azure/Cloud Workflow** - 6개 Azure 피드 (08:00, 16:00, 23:00 KST)

Azure Functions (.NET 8 Isolated), Azure OpenAI, Azure Table Storage를 기반으로 실행됩니다.

## 아키텍처 다이어그램

```mermaid
graph TB
    subgraph "트리거"
        T1["반복 트리거 #1
        Security: 07:00, 15:00, 22:00 KST"]
        T2["반복 트리거 #2
        Azure/Cloud: 08:00, 16:00, 23:00 KST"]
    end
    
    subgraph "Logic App #1: Security"
        LA1[Security Workflow]
        
        subgraph "Security RSS 피드 (5개)"
            RSS1[🛡️ MS Security Blog]
            RSS2[🔐 MS Sentinel]
            RSS3[🌐 Zero Trust]
            RSS4[🎯 Threat Intelligence]
            RSS5[💡 Cybersecurity Insights]
        end
    end
    
    subgraph "Logic App #2: Azure/Cloud"
        LA2[Azure/Cloud Workflow]
        
        subgraph "Azure RSS 피드 (6개)"
            RSS6[🔧 Azure DevOps]
            RSS7[📊 Azure Architecture]
            RSS8[🏗️ Azure Infrastructure]
            RSS9[🏢 Azure Governance]
            RSS10[🔨 DevOps Community]
            RSS11[⚡ Integration Services]
        end
    end
    
    subgraph "데이터 처리"
        PARSE[RSS XML 파싱]
        FILTER["날짜 필터링\n최근 24시간"]
        CHECK[처리 여부 확인]
    end
    
    subgraph "콘텐츠 생성"
        SUM["게시글 요약\nAzure Function"]
        GEN["이메일 HTML 생성\nAzure Function"]
    end
    
    SEND["이메일 발송\nOffice 365"]
    
    subgraph "Azure Functions (.NET 8)"
        F1["CheckDuplicate API\nHTTP Trigger"]
        F2["SummarizePost API\nHTTP Trigger"]
        F3["InsertProcessed API\nHTTP Trigger"]
        F4["GetRecentPosts API\nHTTP Trigger"]
        F5["GenerateEmailHtml API\nHTTP Trigger"]
    end
    
    subgraph "Azure 서비스"
        AOAI["Azure OpenAI\nGPT-4o"]
        STORAGE["Azure Table Storage\nProcessedPosts"]
        APPINS["Application Insights\n모니터링"]
    end
    
    T1 --> LA1
    T2 --> LA2
    LA1 --> RSS1 & RSS2 & RSS3 & RSS4 & RSS5
    LA2 --> RSS6 & RSS7 & RSS8 & RSS9 & RSS10 & RSS11
    RSS1 & RSS2 & RSS3 & RSS4 & RSS5 --> PARSE
    RSS6 & RSS7 & RSS8 & RSS9 & RSS10 & RSS11 --> PARSE
    PARSE --> FILTER
    FILTER --> CHECK
    CHECK -->|중복 확인| F1
    F1 -->|신규 게시글| SUM
    F1 -->|이미 처리됨| STORAGE
    SUM --> F2
    F2 --> AOAI
    AOAI --> F2
    F2 -->|요약 완료| F3
    F3 --> STORAGE
    F3 -->|저장 완료| GEN
    GEN -->|신규 게시글 있음| F5
    GEN -->|신규 게시글 없음| F4
    F4 --> STORAGE
    F5 --> SEND
    F4 --> SEND
    SEND -->|이메일 전송 완료| END((종료))
    F1 & F2 & F3 & F4 & F5 --> APPINS
    
    style T1 fill:#90EE90
    style T2 fill:#90EE90
    style AOAI fill:#FFD700
    style STORAGE fill:#87CEEB
    style APPINS fill:#FFA07A
    style SEND fill:#DDA0DD
```

## 컴포넌트 아키텍처

```mermaid
graph LR
    subgraph "프레젠테이션 계층"
        EMAIL["이메일 클라이언트\nOutlook/Gmail"]
    end
    
    subgraph "오케스트레이션 계층"
        LOGICAPP["Logic App Standard\n워크플로우 오케스트레이션"]
    end
    
    subgraph "애플리케이션 계층"
        FUNC_BUILD["BuildDigest\n.NET 8 Function\n통합 처리 엔진"]
        FUNC_LEGACY["레거시 Functions\nGetRecentPosts, ListRssFeedItems"]
    end
    
    subgraph "AI 계층"
        OPENAI["Azure OpenAI\nGPT-4o 모델"]
    end
    
    subgraph "데이터 계층"
        TABLE["Table Storage\nProcessedPosts"]
    end
    
    subgraph "외부 서비스"
        RSS["RSS 피드\n11개 소스"]
        OFFICE["Office 365\nSMTP"]
    end
    
    EMAIL -.->|수신| OFFICE
    LOGICAPP -->|BuildDigest 호출| FUNC_BUILD
    LOGICAPP -->|조회 선택| FUNC_LEGACY
    LOGICAPP -->|읽기| RSS
    LOGICAPP -->|발송| OFFICE
    FUNC_BUILD -->|중복 체크| TABLE
    FUNC_BUILD -->|웹 스크래핑| RSS
    FUNC_BUILD -->|AOAI 인사이트| OPENAI
    FUNC_BUILD -->|저장| TABLE
    FUNC_LEGACY -->|읽기| TABLE
    
    style EMAIL fill:#E6F3FF
    style LOGICAPP fill:#FFE6E6
    style FUNC_BUILD fill:#FF6B6B
    style FUNC_LEGACY fill:#E6FFE6
    style OPENAI fill:#FFFACD
    style TABLE fill:#F0E68C
```

## 데이터 플로우 다이어그램

```mermaid
sequenceDiagram
    participant Timer as 반복 타이머
    participant LA1 as Security Workflow
    participant LA2 as Azure Workflow
    participant RSS as RSS 피드
    participant TS as Table Storage
    participant F1 as SummarizePost
    participant AOAI as Azure OpenAI
    participant F2 as GenerateEmailHtml
    participant O365 as Office 365
    participant User as 이메일 수신자
    
    Note over Timer,LA2: Security Workflow (07:00, 15:00, 22:00)
    Timer->>LA1: 트리거 (Security)
    
    loop 각 RSS 피드 (5개 - Security)
        LA1->>RSS: RSS 피드 가져오기
        RSS-->>LA1: XML 반환
        LA1->>LA1: XML을 JSON으로 파싱
        LA1->>LA1: 게시글 필터링 (최근 24시간)
        
        loop 각 신규 게시글
            LA1->>TS: 처리 여부 확인
            TS-->>LA1: 처리 상태 반환
            
            alt 미처리
                LA1->>F1: POST /SummarizePost
                F1->>AOAI: 콘텐츠 요약
                AOAI-->>F1: 영문 + 한글 요약
                F1->>TS: 처리됨 표시
                F1-->>LA1: 요약 반환
            else 처리됨
                LA1->>LA1: 건너뛰기
            end
        end
    end
    
    LA1->>F2: POST /GenerateEmailHtml
    F2->>TS: 모든 신규 게시글 가져오기
    F2->>F2: HTML 템플릿 생성
    F2-->>LA1: HTML + 제목 반환
    LA1->>O365: 이메일 발송 (HTML 본문)
    O365-->>User: 이메일 전달
    
    Note over Timer,LA2: Azure Workflow (08:00, 16:00, 23:00)
    Timer->>LA2: 트리거 (Azure)
    
    loop 각 RSS 피드 (6개 - Azure)
        LA2->>RSS: RSS 피드 가져오기
        Note over LA2,F2: 동일한 처리 프로세스
    end
    
    LA2->>O365: 이메일 발송
    O365-->>User: 이메일 전달
```

## 인프라 배포 아키텍처

```mermaid
graph TB
    subgraph "버전 관리"
        REPO["GitHub 리포지토리\nazure-security-blog-automation"]
    end
    
    subgraph "Infrastructure as Code"
        BICEP["Bicep 템플릿\nmain.bicep + 모듈"]
        PARAMS["파라미터 파일\ndev.bicepparam"]
    end
    
    subgraph "배포"
        SCRIPT["배포 스크립트\ndeploy.ps1/deploy.sh"]
        AZCLI["Azure CLI\nBicep 배포"]
    end
    
    subgraph "Azure 리소스"
        RG["리소스 그룹\nrg-security-blog-automation-dev"]
        
        subgraph "컴퓨팅"
            FUNCAPP["Function App\nConsumption Plan"]
            LAAPP["Logic App\nStandard SKU"]
        end
        
        subgraph "스토리지"
            SA["Storage Account\nstdevsecurityblog"]
        end
        
        subgraph "모니터링"
            AI[Application Insights]
            LAW[Log Analytics Workspace]
        end
        
        subgraph "AI 서비스"
            AOAI2["Azure OpenAI\n외부 리소스"]
        end
    end
    
    REPO --> BICEP
    REPO --> PARAMS
    REPO --> SCRIPT
    SCRIPT --> AZCLI
    AZCLI --> RG
    RG --> FUNCAPP
    RG --> LAAPP
    RG --> SA
    RG --> AI
    RG --> LAW
    FUNCAPP -.->|참조| AOAI2
    
    style REPO fill:#E1F5FF
    style BICEP fill:#FFE5E5
    style AZCLI fill:#E5FFE5
    style RG fill:#FFF4E5
```

## 주요 컴포넌트

### 1. Logic App Standard 워크플로우

**목적**: 전체 블로그 게시글 수집 및 이메일 생성 프로세스 오케스트레이션

**듀얼 워크플로우 구조**:

#### Workflow #1: Security
- **반복 트리거**: 매일 07:00, 15:00, 22:00 KST에 실행
- **RSS 피드 처리**: 5개의 Microsoft 보안 블로그 RSS 피드 수집 및 파싱
  - 🛡️ Microsoft Security Blog
  - 🔐 Microsoft Sentinel Blog
  - 🌐 Zero Trust Blog
  - 🎯 Threat Intelligence
  - 💡 Cybersecurity Insights
- **중복 제거**: Table Storage를 통해 동일한 게시글 재처리 방지
- **HTTP 액션**: Azure Functions 호출 (AI 요약 및 HTML 생성)
- **이메일 전송**: Office 365 커넥터를 통한 이메일 발송

#### Workflow #2: Azure/Cloud
- **반복 트리거**: 매일 08:00, 16:00, 23:00 KST에 실행
- **RSS 피드 처리**: 6개의 Azure/Cloud 블로그 RSS 피드 수집 및 파싱
  - 🔧 Azure DevOps Blog
  - 📊 Azure Architecture Blog
  - 🏗️ Azure Infrastructure Blog
  - 🏢 Azure Governance and Management Blog
  - 🔨 Azure DevOps Community
  - ⚡ Azure Integration Services Blog
- **동일한 처리 프로세스**: Security 워크플로우와 동일한 로직

**워크플로우 파일**: 
- Security: `/infra/logic-app/workflow-full.json`
- Azure/Cloud: `/infra/logic-app/workflow-azure-cloud.json`

### 2. Azure Functions (.NET 8 Isolated)

#### 🔥 BuildDigest Function (v3.0 통합 처리 엔진)
- **트리거**: HTTP POST
- **엔드포인트**: `/api/BuildDigest`
- **입력**: 
  ```json
  {
    "rssFeedUrls": [
      {"name": "Microsoft Security Blog", "url": "https://..."}
    ],
    "cutoffHours": 24
  }
  ```
- **처리 과정**:
  1. **RSS 피드 수집**: 모든 피드를 순차 처리 (FAIL 피드 자동 skip)
  2. **웹 스크래핑**: 실제 블로그 페이지에서 첫 문단 추출 (wp-block-paragraph 패턴)
  3. **중복 제거**: Table Storage SHA256 해시 체크
  4. **AOAI 인사이트**: 배치 처리로 한국어 핵심 인사이트 생성
  5. **24시간 필터링**: newCutoff 기준으로 신규 게시물만 표시
  6. **이메일 HTML 생성**: 첫 문단 + 인사이트 포함
- **출력**: 
  ```json
  {
    "subject": "[Microsoft Azure 업데이트] 새 게시글 3개",
    "htmlBody": "<html>...</html>",
    "hasNewPosts": true
  }
  ```
- **목적**: 단일 API 호출로 전체 처리 완료 (Logic App 간소화)
- **상세 문서**: [BuildDigest-API.md](BuildDigest-API.md)

#### 레거시 Functions (v2.0, 현재 BuildDigest로 통합됨)
- `CheckDuplicate`: 중복 체크 (BuildDigest 내부 로직으로 통합)
- `SummarizePost`: 요약 생성 (BuildDigest 내부 로직으로 통합)
- `InsertProcessed`: 저장 (BuildDigest 내부 로직으로 통합)
- `GenerateEmailHtml`: HTML 생성 (BuildDigest 내부 로직으로 통합)

#### 보조 Functions (조회 전용)
- `GetRecentPosts`: 최근 처리된 게시글 조회
- `ListRssFeedItems`: RSS 피드 아이템 목록

**공통 구성**:
- **.NET 8 Isolated Worker**: 프로세스 격리 모드로 안정성 향상
- **TableServiceClient**: `AzureWebJobsStorage` 연결 문자열 사용
- **Application Insights**: 모든 Functions에서 자동 텔레메트리 수집
- **오류 처리**: Try-catch 블록으로 예외 포착, 500 상태 코드 반환

### 3. Azure Table Storage

**테이블**: `ProcessedPosts`

**스키마**:
- **PartitionKey**: 피드 소스 이름 (예: "Microsoft Security Blog", "Azure DevOps Blog")
- **RowKey**: 게시글 링크의 SHA256 해시 (Base64 URL-safe 인코딩)
- **Title**: 게시글 제목
- **Link**: 게시글 원본 URL
- **PublishDate**: 게시 타임스탬프 (ISO 8601)
- **ProcessedDate**: 처리 시간 (ISO 8601)
- **KoreanSummary**: AI 생성 한글 인사이트 (JSON 배열)
- **FirstParagraph**: 웹 스크래핑으로 추출한 첫 문단

**목적**: 
- 블로그 게시글 중복 제거 (SHA256 해시 기반)
- 처리 이력 추적 (BuildDigest에서 자동 저장)
- 최근 게시글 조회 (GetRecentPosts Function)
- 안정적 고유성 보장 (URL 변경에도 대응)

**인덱싱**:
- PartitionKey로 소스별 분리 (효율적 쿼리)
- ProcessedDate 필터로 최근 게시글 검색
- RowKey로 빠른 중복 확인 (O(1) 조회)

### 4. Azure OpenAI

**모델**: GPT-4o
**배포**: `gpt-4o`

**사용 목적**:
- 블로그 전체 분석 기반 핵심 인사이트 추출
- 한국어 3줄 요약 생성 (단순 번역 아님)
- 배치 처리로 효율성 향상
- 보안 핵심 인사이트 추출

**구성**:
- 엔드포인트: 환경 변수 `AZURE_OPENAI_ENDPOINT`
- API 키: Function App 설정에 보안 저장

### 5. Application Insights

**목적**: 모니터링 및 진단

**텔레메트리**:
- Function 실행 로그
- HTTP 요청/응답 추적
- 예외 추적
- 성능 메트릭
- 사용자 정의 이벤트 (게시글 처리, 이메일 생성)

## RSS 피드 소스

현재 **Phase 2**: 10개 피드 (Security 5 + AI Agent 2 + Azure 핵심 3)

| 아이콘 | 피드 이름 | URL | 콘텐츠 주제 |
|--------|-----------|-----|------------|
| 🔒 | Microsoft Security Blog | https://www.microsoft.com/en-us/security/blog/feed/ | 일반 보안 주제 |
| 🔍 | MS Security - Threat Intelligence | https://www.microsoft.com/en-us/security/blog/topic/threat-intelligence/feed/ | 위협 분석 및 인텔리전스 |
| 🛡️ | Microsoft Defender TechCommunity | https://techcommunity.microsoft.com/plugins/custom/microsoft/o365/custom-blog-rss?board=MicrosoftDefenderATPBlog | Microsoft Defender 업데이트 |
| ☁️ | Azure Security Blog | https://azure.microsoft.com/en-us/blog/topics/security/feed/ | Azure 특화 보안 |
| 👁️ | Microsoft Sentinel TechCommunity | https://techcommunity.microsoft.com/plugins/custom/microsoft/o365/custom-blog-rss?board=MicrosoftSentinelBlog | Sentinel SIEM 플랫폼 |
| 🤖 | Azure AI Blog | https://techcommunity.microsoft.com/plugins/custom/microsoft/o365/custom-blog-rss?board=AzureAIBlog | Azure AI 서비스, GPT-4, Copilot Studio |
| 🧠 | Microsoft 365 Copilot Blog | https://techcommunity.microsoft.com/plugins/custom/microsoft/o365/custom-blog-rss?board=Microsoft365CopilotBlog | M365 Copilot, 에이전트, 확장성 |
| ☁️ | Azure Blog | https://azure.microsoft.com/en-us/blog/feed/ | Azure 전반 업데이트, 신규 서비스 |
| ⚙️ | Azure DevOps Blog | https://devblogs.microsoft.com/devops/feed/ | DevOps, CI/CD, GitHub Actions |
| 🔷 | Microsoft Fabric Blog | https://blog.fabric.microsoft.com/en-us/blog/feed/ | Fabric, 데이터 통합, Analytics |

> **MVP 단계적 확장 계획**:
> - ✅ **Phase 1** (완료): 7개 피드 - Security 5개 + AI Agent 핵심 2개
> - ✅ **Phase 2** (현재): 10개 피드 - Azure 핵심 3개 추가
> - 🔜 **Phase 3** (최종): 12개 피드 - Apps, Entra, Architecture 추가

## 보안 및 모범 사례

### 인증 및 권한 부여
- **관리 ID**: Logic App은 시스템 할당 관리 ID 사용
- **API 키**: Azure Key Vault 또는 Function App 애플리케이션 설정에 보안 저장
- **HTTPS 전용**: 모든 엔드포인트에서 TLS 1.2+ 강제 적용

### 네트워크 보안
- **프라이빗 엔드포인트**: (선택 사항) Storage Account에 구성 가능
- **CORS**: Function App CORS를 Azure Portal로만 제한
- **IP 제한**: (선택 사항) Function App 액세스 제한 가능

### 모니터링 및 알림
- **Application Insights**: 전체 텔레메트리 및 분산 추적
- **Azure Monitor**: Function 실패 또는 높은 지연 시간에 대한 경고
- **Logic App 실행 기록**: 모든 워크플로우 실행 추적

### 비용 최적화
- **Consumption Plan**: Functions가 유휴 상태일 때 스케일링
- **Standard SKU Logic App**: 예측 가능한 가격의 고정 비용
- **Table Storage**: 중복 제거를 위한 저비용 데이터 스토리지

## 배포 모델

### Infrastructure as Code (IaC)

모든 Azure 리소스는 Bicep 템플릿으로 정의됩니다:

```
infra/bicep/
├── main.bicep                    # 메인 오케스트레이션 템플릿
├── modules/
│   ├── storage.bicep             # Storage Account + ProcessedPosts 테이블
│   ├── function-app.bicep        # Function App + App Service Plan
│   ├── logic-app.bicep           # Logic App + App Service Plan
│   └── app-insights.bicep        # Application Insights + Log Analytics
└── parameters/
    ├── dev.bicepparam            # 개발 환경
    └── prod.bicepparam           # 프로덕션 환경 (선택 사항)
```

### 배포 스크립트

- **PowerShell**: `infra/deploy.ps1` (Windows)
- **Bash**: `infra/deploy.sh` (Linux/Mac)

**기능**:
- 사전 요구사항 확인 (Azure CLI, 로그인 상태)
- 리소스 그룹 생성
- Bicep 템플릿 검증
- 자동화된 배포
- 출력 표시 (리소스 이름, URL)

## 확장성 및 성능

### 현재 용량
- **RSS 피드**: 5개 피드, 하루 ~50개 게시글
- **이메일 빈도**: 하루 3회 (07:00, 15:00, 22:00 KST)
- **Function 타임아웃**: 5분 (기본값)
- **Table Storage**: 무제한 행, 피드 소스별 파티셔닝

### 확장 고려사항
- **더 많은 RSS 피드**: Logic App 워크플로우에 병렬 브랜치 추가
- **높은 빈도**: Recurrence 트리거 조정 (cron 표현식 지원)
- **여러 수신자**: Office 365 To/CC 필드에 추가
- **대용량**: 더 나은 성능을 위해 Function App을 Premium Plan으로 업그레이드

## 재해 복구 및 백업

### 백업 전략
- **소스 코드**: GitHub에서 버전 관리
- **인프라**: Bicep 템플릿을 통해 재현 가능
- **Table Storage**: 일시 삭제 및 특정 시점 복원 활성화
- **비밀**: Azure Key Vault에 백업

### 복구 절차
1. **완전한 인프라 손실**: 
   - Bicep 템플릿으로 `deploy.ps1` 실행
   - Azure Functions Core Tools를 통해 Function App 코드 재배포
   - `/infra/logic-app/workflow-full.json`에서 Logic App 워크플로우 임포트
   - API 연결 재구성

2. **Function App 장애**:
   - 코드 재배포: `func azure functionapp publish <function-app-name>`

3. **Logic App 워크플로우 손상**:
   - Git 리포지토리에서 워크플로우 정의 임포트

## 향후 개선 사항

### 계획된 기능
- [ ] **이메일 커스터마이징**: 피드 선택을 위한 사용자 기본 설정
- [ ] **다국어**: 추가 언어 요약 지원
- [ ] **Slack/Teams 통합**: 협업 플랫폼에 요약 게시
- [ ] **히스토리 아카이브**: 과거 요약을 탐색할 수 있는 웹 프론트엔드
- [ ] **ML 기반 우선순위**: ML을 사용하여 관련성별로 게시글 순위 지정

### 인프라 개선
- [ ] **프라이빗 엔드포인트**: 향상된 네트워크 보안
- [ ] **다중 지역 배포**: Azure 지역 간 고가용성
- [ ] **Cosmos DB**: 글로벌 배포를 위해 Table Storage에서 마이그레이션
- [ ] **API Management**: 외부 통합을 위해 APIM을 통해 Functions 노출

## 참고 자료

- [Azure Logic Apps 문서](https://learn.microsoft.com/ko-kr/azure/logic-apps/)
- [Azure Functions .NET Isolated](https://learn.microsoft.com/ko-kr/azure/azure-functions/dotnet-isolated-process-guide)
- [Azure OpenAI Service](https://learn.microsoft.com/ko-kr/azure/ai-services/openai/)
- [Azure Table Storage](https://learn.microsoft.com/ko-kr/azure/storage/tables/)
- [Bicep 언어](https://learn.microsoft.com/ko-kr/azure/azure-resource-manager/bicep/)
